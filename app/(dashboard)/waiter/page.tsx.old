'use client';

import { useState, useEffect, useCallback } from 'react';
import { useVenueStore } from '@/stores';
import { supabase } from '@/lib/supabase';
import { PanelHeader } from '@/components/panels/PanelHeader';
import {
  UtensilsCrossed,
  Users,
  Clock,
  AlertCircle,
  Bell,
  Plus,
  ChevronRight,
  Coffee,
  Utensils,
  ShoppingBag,
  Check,
  MessageSquare,
  Timer,
  Loader2,
  RefreshCw,
  X,
  CreditCard,
  Wallet,
  Phone,
  MapPin,
  Bike,
  Store,
  ChefHat,
  Volume2,
  VolumeX
} from 'lucide-react';

interface TableData {
  id: string;
  number: string;
  capacity: number;
  section: string;
  status: 'available' | 'occupied' | 'reserved' | 'cleaning';
  current_guests?: number;
  customer_name?: string;
  seated_at?: string;
}

// Customer App ile uyumlu item yapƒ±sƒ±
interface OrderItem {
  id: string;
  name: string;
  price: number;
  quantity: number;
  options?: { option: string; choice: string; price: number }[];
  status: 'pending' | 'preparing' | 'ready' | 'served';
}

// Customer App ile uyumlu order yapƒ±sƒ±
interface Order {
  id: string;
  order_number: string;
  venue_id: string;
  user_id?: string;
  type: 'dine_in' | 'takeaway' | 'delivery';
  status: 'pending' | 'confirmed' | 'preparing' | 'ready' | 'served' | 'completed' | 'cancelled';
  payment_status: 'pending' | 'partial' | 'paid';
  payment_method?: 'cash' | 'card' | 'tit_pay';
  subtotal: number;
  tax: number;
  tip?: number;
  delivery_fee?: number;
  total: number;
  notes?: string;
  customer_name?: string;
  customer_phone?: string;
  table_number?: string;
  delivery_address?: {
    title: string;
    full_address: string;
    district: string;
    city: string;
  };
  estimated_time?: number;
  split_count?: number;
  items: OrderItem[];
  created_at: string;
  updated_at?: string;
}

// Sipari≈ü detay modalƒ±
interface OrderDetailModalProps {
  order: Order;
  onClose: () => void;
  onUpdateStatus: (orderId: string, status: string) => void;
  onUpdateItemStatus: (orderId: string, itemId: string, status: string) => void;
}

function OrderDetailModal({ order, onClose, onUpdateStatus, onUpdateItemStatus }: OrderDetailModalProps) {
  const statusLabels: Record<string, { label: string; color: string }> = {
    pending: { label: 'Bekliyor', color: 'bg-amber-500' },
    confirmed: { label: 'Onaylandƒ±', color: 'bg-blue-500' },
    preparing: { label: 'Hazƒ±rlanƒ±yor', color: 'bg-purple-500' },
    ready: { label: 'Hazƒ±r', color: 'bg-green-500' },
    served: { label: 'Servis Edildi', color: 'bg-gray-500' },
    completed: { label: 'Tamamlandƒ±', color: 'bg-gray-600' },
    cancelled: { label: 'ƒ∞ptal', color: 'bg-red-500' }
  };

  const typeIcons: Record<string, JSX.Element> = {
    dine_in: <Store className="w-5 h-5" />,
    takeaway: <ShoppingBag className="w-5 h-5" />,
    delivery: <Bike className="w-5 h-5" />
  };

  const typeLabels: Record<string, string> = {
    dine_in: 'Masada',
    takeaway: 'Paket',
    delivery: 'Teslimat'
  };

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-800 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="p-4 border-b border-gray-700 flex items-center justify-between">
          <div>
            <div className="flex items-center gap-2">
              <h2 className="text-xl font-bold text-white">{order.order_number}</h2>
              <span className={`px-2 py-0.5 rounded text-xs font-medium ${statusLabels[order.status]?.color || 'bg-gray-500'}`}>
                {statusLabels[order.status]?.label || order.status}
              </span>
            </div>
            <div className="flex items-center gap-2 text-sm text-gray-400 mt-1">
              {typeIcons[order.type]}
              <span>{typeLabels[order.type]}</span>
              {order.type === 'dine_in' && order.table_number && (
                <span className="text-orange-400">‚Ä¢ Masa {order.table_number}</span>
              )}
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-gray-700 rounded-lg">
            <X className="w-5 h-5 text-gray-400" />
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          {/* M√º≈üteri Bilgileri */}
          {(order.customer_name || order.customer_phone) && (
            <div className="bg-gray-700/50 rounded-xl p-3">
              <h3 className="text-sm font-medium text-gray-400 mb-2">M√º≈üteri</h3>
              {order.customer_name && (
                <p className="text-white font-medium">{order.customer_name}</p>
              )}
              {order.customer_phone && (
                <a href={`tel:${order.customer_phone}`} className="flex items-center gap-2 text-blue-400 text-sm mt-1">
                  <Phone className="w-4 h-4" />
                  {order.customer_phone}
                </a>
              )}
            </div>
          )}

          {/* Teslimat Adresi */}
          {order.type === 'delivery' && order.delivery_address && (
            <div className="bg-gray-700/50 rounded-xl p-3">
              <h3 className="text-sm font-medium text-gray-400 mb-2">Teslimat Adresi</h3>
              <div className="flex items-start gap-2">
                <MapPin className="w-4 h-4 text-green-400 mt-0.5" />
                <div>
                  <p className="text-white font-medium">{order.delivery_address.title}</p>
                  <p className="text-gray-400 text-sm">{order.delivery_address.full_address}</p>
                  <p className="text-gray-500 text-xs">{order.delivery_address.district}, {order.delivery_address.city}</p>
                </div>
              </div>
            </div>
          )}

          {/* √úr√ºnler */}
          <div className="bg-gray-700/50 rounded-xl overflow-hidden">
            <div className="p-3 border-b border-gray-600">
              <h3 className="text-sm font-medium text-gray-400">√úr√ºnler ({order.items.length})</h3>
            </div>
            <div className="divide-y divide-gray-600">
              {order.items.map((item, idx) => (
                <div key={item.id || idx} className="p-3 flex items-center gap-3">
                  <button
                    onClick={() => {
                      const nextStatus = item.status === 'pending' ? 'preparing' 
                        : item.status === 'preparing' ? 'ready' 
                        : item.status === 'ready' ? 'served' 
                        : 'served';
                      onUpdateItemStatus(order.id, item.id, nextStatus);
                    }}
                    className={`w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 transition-colors ${
                      item.status === 'served' ? 'bg-gray-600' :
                      item.status === 'ready' ? 'bg-green-600 hover:bg-green-500' :
                      item.status === 'preparing' ? 'bg-purple-600 hover:bg-purple-500' :
                      'bg-amber-600 hover:bg-amber-500'
                    }`}
                  >
                    {item.status === 'served' ? <Check className="w-4 h-4" /> : item.quantity}
                  </button>
                  <div className="flex-1">
                    <p className={`font-medium ${item.status === 'served' ? 'text-gray-500 line-through' : 'text-white'}`}>
                      {item.name}
                    </p>
                    {item.options && item.options.length > 0 && (
                      <p className="text-xs text-gray-500">
                        {item.options.map(o => o.choice).join(', ')}
                      </p>
                    )}
                  </div>
                  <span className="text-gray-400">‚Ç∫{item.price * item.quantity}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Not */}
          {order.notes && (
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3">
              <div className="flex items-center gap-2 text-amber-400">
                <MessageSquare className="w-4 h-4" />
                <span className="text-sm font-medium">Sipari≈ü Notu</span>
              </div>
              <p className="text-amber-200 text-sm mt-1">{order.notes}</p>
            </div>
          )}

          {/* √ñzet */}
          <div className="bg-gray-700/50 rounded-xl p-3 space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-gray-400">Ara Toplam</span>
              <span className="text-white">‚Ç∫{order.subtotal}</span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-gray-400">KDV</span>
              <span className="text-white">‚Ç∫{order.tax}</span>
            </div>
            {order.tip && order.tip > 0 && (
              <div className="flex justify-between text-sm text-green-400">
                <span>Bah≈üi≈ü</span>
                <span>+‚Ç∫{order.tip}</span>
              </div>
            )}
            {order.delivery_fee && order.delivery_fee > 0 && (
              <div className="flex justify-between text-sm text-green-400">
                <span>Teslimat</span>
                <span>+‚Ç∫{order.delivery_fee}</span>
              </div>
            )}
            <div className="flex justify-between text-lg font-bold pt-2 border-t border-gray-600">
              <span className="text-white">Toplam</span>
              <span className="text-orange-500">‚Ç∫{order.total}</span>
            </div>
            {order.split_count && order.split_count > 1 && (
              <div className="flex justify-between text-sm text-purple-400">
                <span>{order.split_count} ki≈üi</span>
                <span>‚Ç∫{Math.ceil(order.total / order.split_count)} / ki≈üi</span>
              </div>
            )}
          </div>
        </div>

        {/* Actions */}
        <div className="p-4 border-t border-gray-700 space-y-2">
          {order.status === 'pending' && (
            <button
              onClick={() => onUpdateStatus(order.id, 'confirmed')}
              className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold flex items-center justify-center gap-2"
            >
              <Check className="w-5 h-5" />
              Sipari≈üi Onayla
            </button>
          )}
          {order.status === 'confirmed' && (
            <button
              onClick={() => onUpdateStatus(order.id, 'preparing')}
              className="w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold flex items-center justify-center gap-2"
            >
              <ChefHat className="w-5 h-5" />
              Mutfaƒüa G√∂nder
            </button>
          )}
          {order.status === 'ready' && (
            <button
              onClick={() => onUpdateStatus(order.id, 'served')}
              className="w-full py-3 bg-green-600 hover:bg-green-500 rounded-xl font-bold flex items-center justify-center gap-2"
            >
              <UtensilsCrossed className="w-5 h-5" />
              Servis Edildi
            </button>
          )}
          {order.status === 'served' && order.payment_status === 'pending' && (
            <button
              onClick={() => {
                // POS'a y√∂nlendir
                window.location.href = `/pos?order=${order.id}`;
              }}
              className="w-full py-3 bg-amber-600 hover:bg-amber-500 rounded-xl font-bold flex items-center justify-center gap-2"
            >
              <CreditCard className="w-5 h-5" />
              √ñdeme Al
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

export default function WaiterPage() {
  const { currentVenue } = useVenueStore();
  const [tables, setTables] = useState<TableData[]>([]);
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [mounted, setMounted] = useState(false);
  const [displayTime, setDisplayTime] = useState<string>('--:--:--');
  const [selectedSection, setSelectedSection] = useState<string>('all');
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);
  const [activeTab, setActiveTab] = useState<'all' | 'dine_in' | 'takeaway' | 'delivery'>('all');

  // Fetch tables
  const fetchTables = useCallback(async () => {
    if (!currentVenue?.id) return;
    
    const { data, error } = await supabase
      .from('tables')
      .select('*')
      .eq('venue_id', currentVenue.id)
      .eq('is_active', true)
      .order('number');

    if (error) {
      console.error('Tables fetch error:', error);
      return;
    }

    setTables(data || []);
  }, [currentVenue?.id]);

  // Fetch orders - Customer App uyumlu
  const fetchOrders = useCallback(async () => {
    if (!currentVenue?.id) return;
    
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .eq('venue_id', currentVenue.id)
      .in('status', ['pending', 'confirmed', 'preparing', 'ready', 'served'])
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Orders fetch error:', error);
      return;
    }

    // items zaten JSON olarak geliyor, parse etmeye gerek yok
    const processedOrders: Order[] = (data || []).map(order => ({
      ...order,
      items: Array.isArray(order.items) ? order.items : []
    }));

    setOrders(processedOrders);
  }, [currentVenue?.id]);

  // Initial mount
  useEffect(() => {
    setMounted(true);
    const updateTime = () => setDisplayTime(new Date().toLocaleTimeString('tr-TR'));
    updateTime();
    const timer = setInterval(updateTime, 1000);
    return () => clearInterval(timer);
  }, []);

  // Fetch data
  useEffect(() => {
    if (currentVenue?.id && mounted) {
      setLoading(true);
      Promise.all([fetchTables(), fetchOrders()]).finally(() => setLoading(false));
    }
  }, [currentVenue?.id, mounted, fetchTables, fetchOrders]);

  // Real-time subscriptions
  useEffect(() => {
    if (!currentVenue?.id) return;

    const ordersChannel = supabase
      .channel('waiter_orders')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'orders',
        filter: `venue_id=eq.${currentVenue.id}`
      }, (payload) => {
        console.log('Order change:', payload);
        fetchOrders();
        // Yeni sipari≈ü bildirimi
        if (payload.eventType === 'INSERT' && soundEnabled) {
          // Ses √ßal
          try {
            const audio = new Audio('/sounds/new-order.mp3');
            audio.play().catch(() => {});
          } catch {}
        }
      })
      .subscribe();

    const tablesChannel = supabase
      .channel('waiter_tables')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'tables',
        filter: `venue_id=eq.${currentVenue.id}`
      }, () => fetchTables())
      .subscribe();

    return () => {
      ordersChannel.unsubscribe();
      tablesChannel.unsubscribe();
    };
  }, [currentVenue?.id, soundEnabled, fetchOrders, fetchTables]);

  // Update order status
  const updateOrderStatus = async (orderId: string, newStatus: string) => {
    const { error } = await supabase
      .from('orders')
      .update({ 
        status: newStatus, 
        updated_at: new Date().toISOString() 
      })
      .eq('id', orderId);

    if (error) {
      console.error('Order update error:', error);
      alert('Sipari≈ü g√ºncellenemedi: ' + error.message);
      return;
    }

    // Masa durumunu g√ºncelle
    const order = orders.find(o => o.id === orderId);
    if (order?.table_number && newStatus === 'served') {
      const table = tables.find(t => t.number === order.table_number);
      if (table) {
        await supabase
          .from('tables')
          .update({ status: 'occupied' })
          .eq('id', table.id);
      }
    }

    fetchOrders();
    setSelectedOrder(null);
  };

  // Update item status (items JSON i√ßinde)
  const updateItemStatus = async (orderId: string, itemId: string, newStatus: string) => {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    const updatedItems = order.items.map(item => 
      item.id === itemId ? { ...item, status: newStatus } : item
    );

    // T√ºm itemlar ready ise order'ƒ± ready yap
    const allReady = updatedItems.every(item => item.status === 'ready' || item.status === 'served');
    const newOrderStatus = allReady ? 'ready' : order.status;

    const { error } = await supabase
      .from('orders')
      .update({ 
        items: updatedItems,
        status: newOrderStatus,
        updated_at: new Date().toISOString() 
      })
      .eq('id', orderId);

    if (error) {
      console.error('Item update error:', error);
      return;
    }

    fetchOrders();
  };

  // Get unique sections
  const sections = ['all', ...new Set(tables.map(t => t.section).filter(Boolean))];
  
  const filteredTables = selectedSection === 'all' 
    ? tables 
    : tables.filter(t => t.section === selectedSection);

  // Filter orders by type
  const filteredOrders = activeTab === 'all' 
    ? orders 
    : orders.filter(o => o.type === activeTab);

  // Categorize orders
  const pendingOrders = filteredOrders.filter(o => o.status === 'pending');
  const activeOrders = filteredOrders.filter(o => ['confirmed', 'preparing'].includes(o.status));
  const readyOrders = filteredOrders.filter(o => o.status === 'ready');

  // Order card component
  const OrderCard = ({ order, highlight }: { order: Order; highlight?: boolean }) => {
    const isReady = order.status === 'ready';
    const isPending = order.status === 'pending';
    
    const typeConfig = {
      dine_in: { icon: <Store className="w-4 h-4" />, label: 'Masa', color: 'text-blue-400' },
      takeaway: { icon: <ShoppingBag className="w-4 h-4" />, label: 'Paket', color: 'text-purple-400' },
      delivery: { icon: <Bike className="w-4 h-4" />, label: 'Teslimat', color: 'text-green-400' }
    };

    const config = typeConfig[order.type];
    const createdAt = new Date(order.created_at);
    const minutesAgo = Math.floor((Date.now() - createdAt.getTime()) / 60000);

    return (
      <button
        onClick={() => setSelectedOrder(order)}
        className={`w-full text-left rounded-xl p-4 transition-all hover:scale-[1.02] ${
          isReady 
            ? 'bg-green-600/20 border-2 border-green-500 animate-pulse' 
            : isPending
              ? 'bg-amber-600/20 border-2 border-amber-500'
              : 'bg-gray-700/50 border border-gray-600 hover:border-gray-500'
        }`}
      >
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-2">
            <span className="font-bold text-white">{order.order_number}</span>
            {isReady && <Bell className="w-4 h-4 text-green-400 animate-bounce" />}
          </div>
          <div className="flex items-center gap-2 text-sm">
            <Clock className="w-3 h-3 text-gray-500" />
            <span className={minutesAgo > 15 ? 'text-red-400' : 'text-gray-400'}>
              {minutesAgo} dk
            </span>
          </div>
        </div>

        <div className="flex items-center gap-2 mb-2">
          <span className={config.color}>{config.icon}</span>
          <span className="text-sm text-gray-400">
            {order.type === 'dine_in' && order.table_number 
              ? `Masa ${order.table_number}` 
              : config.label}
          </span>
          {order.customer_name && (
            <span className="text-sm text-gray-500">‚Ä¢ {order.customer_name}</span>
          )}
        </div>

        <div className="space-y-1 mb-2">
          {order.items.slice(0, 3).map((item, idx) => (
            <div key={idx} className="flex items-center gap-2 text-sm">
              <span className={`w-2 h-2 rounded-full ${
                item.status === 'ready' ? 'bg-green-500' :
                item.status === 'preparing' ? 'bg-purple-500' :
                item.status === 'served' ? 'bg-gray-500' :
                'bg-amber-500'
              }`} />
              <span className="text-gray-300">{item.quantity}x {item.name}</span>
            </div>
          ))}
          {order.items.length > 3 && (
            <span className="text-xs text-gray-500">+{order.items.length - 3} √ºr√ºn daha</span>
          )}
        </div>

        {order.notes && (
          <div className="flex items-center gap-1 text-xs text-amber-400 mb-2">
            <MessageSquare className="w-3 h-3" />
            <span className="truncate">{order.notes}</span>
          </div>
        )}

        <div className="flex items-center justify-between pt-2 border-t border-gray-600">
          <span className="font-bold text-orange-500">‚Ç∫{order.total}</span>
          <ChevronRight className="w-4 h-4 text-gray-500" />
        </div>
      </button>
    );
  };

  if (!mounted) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center">
        <Loader2 className="w-8 h-8 text-blue-500 animate-spin" />
      </div>
    );
  }

  if (!currentVenue) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <AlertCircle className="w-16 h-16 text-amber-500 mx-auto mb-4" />
          <h2 className="text-xl font-bold text-white mb-2">Mekan Se√ßimi Gerekli</h2>
          <p className="text-gray-400">Garson paneli i√ßin l√ºtfen bir mekan se√ßin.</p>
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-900 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 text-blue-500 mx-auto mb-4 animate-spin" />
          <p className="text-gray-400">Veriler y√ºkleniyor...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-900 text-white -m-6 p-6 pb-24">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center">
            <UtensilsCrossed className="w-6 h-6" />
          </div>
          <div>
            <h1 className="text-2xl font-bold">Garson Paneli</h1>
            <p className="text-gray-400 text-sm">{displayTime} ‚Ä¢ {currentVenue.name}</p>
          </div>
        </div>

        <div className="flex items-center gap-4">
          {/* Stats */}
          <div className="flex items-center gap-4 bg-gray-800 rounded-xl px-4 py-2">
            <div className="text-center">
              <p className="text-xl font-bold text-amber-500">{pendingOrders.length}</p>
              <p className="text-xs text-gray-400">Yeni</p>
            </div>
            <div className="w-px h-8 bg-gray-700" />
            <div className="text-center">
              <p className="text-xl font-bold text-purple-500">{activeOrders.length}</p>
              <p className="text-xs text-gray-400">Aktif</p>
            </div>
            <div className="w-px h-8 bg-gray-700" />
            <div className="text-center">
              <p className="text-xl font-bold text-green-500">{readyOrders.length}</p>
              <p className="text-xs text-gray-400">Hazƒ±r</p>
            </div>
          </div>

          {/* Sound Toggle */}
          <button
            onClick={() => setSoundEnabled(!soundEnabled)}
            className={`p-3 rounded-xl transition-colors ${
              soundEnabled ? 'bg-green-600 hover:bg-green-500' : 'bg-gray-700 hover:bg-gray-600'
            }`}
          >
            {soundEnabled ? <Volume2 className="w-5 h-5" /> : <VolumeX className="w-5 h-5" />}
          </button>

          {/* Refresh */}
          <button
            onClick={() => { fetchTables(); fetchOrders(); }}
            className="p-3 bg-gray-700 hover:bg-gray-600 rounded-xl transition-colors"
          >
            <RefreshCw className="w-5 h-5" />
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Sol: Masa Haritasƒ± */}
        <div className="lg:col-span-2 bg-gray-800/50 rounded-2xl p-4">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-bold">Masa Durumu</h2>
            {/* Section Tabs */}
            <div className="flex gap-2 overflow-x-auto">
              {sections.map(section => (
                <button
                  key={section}
                  onClick={() => setSelectedSection(section)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${
                    selectedSection === section
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                  }`}
                >
                  {section === 'all' ? 'T√ºm√º' : section}
                </button>
              ))}
            </div>
          </div>

          {filteredTables.length > 0 ? (
            <div className="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3">
              {filteredTables.map(table => {
                const tableOrders = orders.filter(o => 
                  o.type === 'dine_in' && 
                  o.table_number === table.number &&
                  !['completed', 'cancelled'].includes(o.status)
                );
                const hasOrder = tableOrders.length > 0;
                const hasReadyOrder = tableOrders.some(o => o.status === 'ready');
                const totalAmount = tableOrders.reduce((sum, o) => sum + o.total, 0);

                return (
                  <button
                    key={table.id}
                    onClick={() => {
                      if (hasOrder) {
                        setSelectedOrder(tableOrders[0]);
                      }
                    }}
                    className={`aspect-square rounded-xl p-2 flex flex-col items-center justify-center transition-all hover:scale-105 ${
                      hasReadyOrder
                        ? 'bg-green-600/30 border-2 border-green-500 animate-pulse'
                        : table.status === 'occupied' || hasOrder
                          ? 'bg-red-600/20 border-2 border-red-500'
                          : table.status === 'available'
                            ? 'bg-green-600/20 border-2 border-green-500/50'
                            : table.status === 'reserved'
                              ? 'bg-amber-600/20 border-2 border-amber-500'
                              : 'bg-blue-600/20 border-2 border-blue-500'
                    }`}
                  >
                    <span className="text-lg font-bold">{table.number}</span>
                    <span className="text-xs text-gray-400">{table.capacity} ki≈üi</span>
                    {table.customer_name && (
                      <span className="text-xs text-blue-400 truncate max-w-full">{table.customer_name}</span>
                    )}
                    {hasOrder && (
                      <span className="text-xs mt-1 text-amber-400 font-medium">‚Ç∫{totalAmount}</span>
                    )}
                    {hasReadyOrder && (
                      <Bell className="w-4 h-4 text-green-400 mt-1 animate-bounce" />
                    )}
                  </button>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-12 text-gray-500">
              <Users className="w-12 h-12 mx-auto mb-2 opacity-50" />
              <p>Hen√ºz masa eklenmemi≈ü</p>
            </div>
          )}

          {/* Legend */}
          <div className="flex flex-wrap gap-4 mt-4 pt-4 border-t border-gray-700">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded bg-green-500/50 border border-green-500" />
              <span className="text-xs text-gray-400">Bo≈ü</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded bg-red-500/50 border border-red-500" />
              <span className="text-xs text-gray-400">Dolu</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded bg-green-500 animate-pulse" />
              <span className="text-xs text-gray-400">Hazƒ±r Sipari≈ü</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded bg-amber-500/50 border border-amber-500" />
              <span className="text-xs text-gray-400">Rezerve</span>
            </div>
          </div>
        </div>

        {/* Saƒü: Sipari≈üler */}
        <div className="bg-gray-800/50 rounded-2xl p-4 flex flex-col">
          {/* Order Type Tabs */}
          <div className="flex gap-1 p-1 bg-gray-700 rounded-lg mb-4">
            {[
              { id: 'all', label: 'T√ºm√º', icon: Utensils },
              { id: 'dine_in', label: 'Masa', icon: Store },
              { id: 'takeaway', label: 'Paket', icon: ShoppingBag },
              { id: 'delivery', label: 'Teslimat', icon: Bike }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex-1 py-2 rounded-md text-xs font-medium flex items-center justify-center gap-1 transition-colors ${
                  activeTab === tab.id
                    ? 'bg-blue-600 text-white'
                    : 'text-gray-400 hover:text-white'
                }`}
              >
                <tab.icon className="w-3 h-3" />
                {tab.label}
              </button>
            ))}
          </div>

          {/* Orders List */}
          <div className="flex-1 overflow-y-auto space-y-3 max-h-[calc(100vh-400px)]">
            {/* Ready Orders (√∂ncelikli) */}
            {readyOrders.length > 0 && (
              <div className="space-y-2">
                <p className="text-xs font-medium text-green-400 uppercase tracking-wider">
                  üîî Hazƒ±r ({readyOrders.length})
                </p>
                {readyOrders.map(order => (
                  <OrderCard key={order.id} order={order} highlight />
                ))}
              </div>
            )}

            {/* Pending Orders */}
            {pendingOrders.length > 0 && (
              <div className="space-y-2">
                <p className="text-xs font-medium text-amber-400 uppercase tracking-wider">
                  ‚è≥ Yeni Sipari≈üler ({pendingOrders.length})
                </p>
                {pendingOrders.map(order => (
                  <OrderCard key={order.id} order={order} />
                ))}
              </div>
            )}

            {/* Active Orders */}
            {activeOrders.length > 0 && (
              <div className="space-y-2">
                <p className="text-xs font-medium text-purple-400 uppercase tracking-wider">
                  üë®‚Äçüç≥ Hazƒ±rlanƒ±yor ({activeOrders.length})
                </p>
                {activeOrders.map(order => (
                  <OrderCard key={order.id} order={order} />
                ))}
              </div>
            )}

            {filteredOrders.length === 0 && (
              <div className="text-center py-8 text-gray-500">
                <Utensils className="w-12 h-12 mx-auto mb-2 opacity-50" />
                <p>Aktif sipari≈ü yok</p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Quick Actions */}
      <div className="fixed bottom-6 left-1/2 -translate-x-1/2 flex gap-3 bg-gray-800 rounded-2xl p-3 shadow-2xl border border-gray-700">
        <button 
          onClick={() => window.location.href = '/tables'}
          className="px-5 py-3 bg-green-600 hover:bg-green-500 rounded-xl font-bold flex items-center gap-2 transition-colors"
        >
          <Plus className="w-5 h-5" />
          Yeni Sipari≈ü
        </button>
        <button className="px-5 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold flex items-center gap-2 transition-colors">
          <Coffee className="w-5 h-5" />
          Hƒ±zlƒ± Sipari≈ü
        </button>
        <button className="px-5 py-3 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold flex items-center gap-2 transition-colors">
          <Bell className="w-5 h-5" />
          √áaƒürƒ±lar
          {/* TODO: Garson √ßaƒürƒ± sayƒ±sƒ± badge */}
        </button>
      </div>

      {/* Order Detail Modal */}
      {selectedOrder && (
        <OrderDetailModal
          order={selectedOrder}
          onClose={() => setSelectedOrder(null)}
          onUpdateStatus={updateOrderStatus}
          onUpdateItemStatus={updateItemStatus}
        />
      )}
    </div>
  );
}
